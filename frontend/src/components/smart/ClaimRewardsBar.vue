<template>
  <div class="body main-font">
    <b-navbar class="claim-xp-bar claim-skill" v-if="isFor == 'claimSkill'">
       <b-nav-item
        class="bar text-right pt-2 pb-2"
        @click="claimSkill(ClaimStage.Summary)">
        <span class="gtag-link-others" tagname="claim_skill" v-tooltip.bottom="$t('ClaimRewardsBar.clickDetails')">
        <span class="btn-claim" v-if="canClaimTokens">CLAIM</span>
        <span class="skill-label">REWARDS | </span>
        <span class="exp-label">SKILL : </span>{{ formattedSkillReward }}
        </span>
      </b-nav-item>
    </b-navbar>
    <b-navbar class="claim-xp-bar" v-if="isFor == 'claimExp'">
      <b-nav-item class="bar d-flex flex-column" disabled>
        <strong>
          <span class="reward-title">{{$t('blacksmith.claimExp')}}</span>
        </strong>
        <p class="note">&#10070; {{$t('ClaimRewardsBar.clickDetailsExp')}}</p>
      </b-nav-item>
      <b-nav-item
        class="bar"
        :disabled="!canClaimXp"
        @click="onClaimXp">
        <p class="exp-label">EXP</p>
        <p class="chars gtag-link-others" v-for="(reward, index) in formattedXpRewards" :key="index"><span class="diamond">&#9830;</span> {{reward}}</p>
      </b-nav-item>
    </b-navbar>

    <b-modal class="centered-modal" ref="need-gas-modal" title="Need Withdraw?"
      @ok="claimSkill(ClaimStage.Stake)" ok-title="Next" @cancel="$router.push({ name: 'portal' })" cancel-title="Go to WAX Portal" >
        {{$t('needGasModal.newToWithdraw')}}
        <div class="text-center">
          <hr class="hr-divider">
          {{$t('needGasModal.holdReminder')}}<br>
          <span v-html="$t('needGasModal.holdReminderText')"></span>
          <div class="row">
            <div class="col-5">{{$t('needGasModal.yourTax')}}</div>
            <div class="col-2"><span class="text-danger font-weight-bold">{{formattedRewardsClaimTax}}</span></div>
            <div class="col-5 text-left">{{$t('needGasModal.reduces1')}}<br>
              {{$t('needGasModal.reduces2')}}</div>
          </div>
        </div>
    </b-modal>
    <b-modal class="centered-modal" ref="stake-suggestion-modal" :title="$t('stakeModal.title')"
      @ok="$router.push({ name: 'select-stake-type' })"
      :ok-title="$t('stakeModal.okTitle')"
      :cancel-title="$t('stakeModal.cancelTitle')"
      >
        {{$t('stakeModal.stakeText')}}
      <a href="#" @click="claimSkill(ClaimStage.Claim)">
      <br>
      <span v-if="(this.rewardsClaimTaxAsFactorBN > 0)">{{$t('stakeModal.bonusWarning1')}}</span>
      <span v-else>{{$t('stakeModal.bonusWarning2', {formattedTaxAmount : this.formattedTaxAmount})}}</span>      </a>
    </b-modal>
    <b-modal class="centered-modal" ref="claim-confirmation-modal"
    :title="$t('stakeModal.confirmModal.title')"
    :ok-title="$t('stakeModal.confirmModal.okTitle')"
    :cancel-title="$t('stakeModal.confirmModal.cancelTitle')"
    @ok="onClaimTokens()">
      <span v-if="(this.rewardsClaimTaxAsFactorBN > 0)">
        {{$t('stakeModal.confirmModal.claimWarning2', {
          formattedRewardsClaimTax,
          formattedTaxAmount : this.formattedTaxAmount,
          formattedBonusLost
          } )}}
      </span>
      <span v-else>
        {{$t('stakeModal.confirmModal.claimWarning1', {formattedBonusLost})}}
      </span>
      <b>{{$t('stakeModal.confirmModal.cantBeUndone')}}</b>
    </b-modal>
    <b-modal class="centered-modal" ref="claim-summary-modal" :title="$t('ClaimRewardsBar.claimRewards')"
      :ok-title="$t('ClaimRewardsBar.claim')" @ok="onClaimTokens()"
      :ok-disabled="(selectedPartneredProject && !canClaimSelectedProject)
        || (!selectedPartneredProject && !canClaimTokens)
        || !isSkillAmountValid">
      <div class="d-flex flex-column align-items-center">
        <div class="d-flex flex-row w-100 align-items-baseline">
          <h5>{{$t('ClaimRewardsBar.payoutCurrency')}}:</h5>
          <b-form-select class="w-50 ml-1" size="sm" :value="payoutCurrencyId" @change="updatePayoutCurrencyId($event)">
            <b-form-select-option v-for="p in getPartnerProjects" :key="p.id" :value="p.id">{{p.tokenSymbol}} ({{p.name}})</b-form-select-option>
          </b-form-select>
        </div>
        <div v-if="selectedPartneredProject" class="d-flex mt-2">
          <div class="d-flex justify-content-center align-items-center">
            <h6 class="claim-input-text">{{$t('ClaimRewardsBar.skillAmount')}}:</h6>
            <b-form-input v-bind:class="!isSkillAmountValid ? 'invalid-amount' : ''"
              type="number" min="0" step="0.0001" :max="skillRewardNumber" v-model="skillAmount" class="claim-input" />
            <a class="" @click="setMaxSkillAmount">(Max)</a>
          </div>
          <div class="d-flex justify-content-center align-items-center">
            <h6 class="claim-input-text">{{$t('ClaimRewardsBar.slippage')}} (%):</h6>
            <b-form-input type="number" max="100" step="0.5" v-model="slippage" class="claim-input" />
          </div>
        </div>
        <PartneredProject v-if="selectedPartneredProject" :partnerProject="selectedPartneredProject" :key="selectedPartneredProject.id"/>
        <div class="mt-3" v-if="selectedPartneredProject && !canClaimSelectedProject">
          <h5>{{$t('ClaimRewardsBar.partnerTokenClaimed')}}</h5>
        </div>
        <div v-if="selectedPartneredProject && canClaimSelectedProject" class="mt-3">
          <h6 v-if="formattedMultiplier < 0.5" class="very-low-multiplier">{{$t('ClaimRewardsBar.lowMultiplier', {currentMultiplier})}}</h6>
          <h6 >{{
              $t('ClaimRewardsBar.realWithdrawValueClaimable', {
                actualAmount: (skillAmount / nonFormattedRatio * formattedMultiplier).toFixed(4),
                tokenSymbol: selectedPartneredProject.tokenSymbol,
                skillAmount: (+skillAmount).toFixed(4)
              })
            }}</h6>
        </div>
        <div class="mt-3" v-if="isNoProjectAvailable">
          <h5>{{$t('ClaimRewardsBar.noProjects')}}</h5>
        </div>
      </div>
    </b-modal>
  </div>
</template>

<script lang="ts">
import Vue from 'vue';
import {Accessors} from 'vue/types/options';
import {mapActions, mapGetters, mapMutations, mapState} from 'vuex';
import BigNumber from 'bignumber.js';
import {RequiredXp} from '../../interfaces';
import {ICharacter} from '@/interfaces';
import {fromWeiEther, toBN} from '../../utils/common';
import {getCleanName} from '../../rename-censor';
import {SupportedProject} from '@/views/Treasury.vue';
import PartneredProject from '../PartneredProject.vue';
import i18n from '@/i18n';

interface StoreMappedState {
  skillRewards: string;
  xpRewards: Record<string, string>;
  ownedCharacterIds: string[];
  directStakeBonusPercent: number;
  payoutCurrencyId: string;
  defaultSlippage: string;
  currentNetworkId: number;
  partnerProjectMultipliers: Record<number, string>;
  partnerProjectRatios: Record<number, string>;
}

interface StoreMappedGetters {
  ownCharacters: ICharacter[];
  currentCharacter: ICharacter | null;
  maxRewardsClaimTaxAsFactorBN: BigNumber;
  rewardsClaimTaxAsFactorBN: BigNumber;
  getCharacterName(id: number): string;
  getPartnerProjects: SupportedProject[];
}

enum ClaimStage {
  WaxBridge = 0,
  Stake = 1,
  Claim = 2,
  Summary = 3
}

interface StoreMappedActions {
  claimTokenRewards(): Promise<void>;
  claimPartnerToken(
    {id, skillAmount, currentMultiplier, slippage}:
    {id: number, skillAmount: string, currentMultiplier: string, slippage: string}): Promise<void>;
  claimXpRewards(): Promise<void>;
  fetchRemainingTokenClaimAmountPreTax(): Promise<string>;
  fetchPartnerProjects(): Promise<void>;
  getPartnerProjectMultiplier(id: number): Promise<string>;
  getSkillToPartnerRatio(id: number): Promise<string>;
}

export default Vue.extend({
  components: { PartneredProject },

  props: {
    isBar: {
      type: Boolean,
      default: true
    },
    isFor: {
      type: String,
      default: null
    }
  },

  data() {
    return {
      ClaimStage,
      remainingTokenClaimAmountPreTax: '0',
      skillAmount: 0,
      slippage: 0,
      updateInterval: null as ReturnType<typeof setInterval> | null,
    };
  },

  computed: {
    ...(mapState(['skillRewards', 'xpRewards', 'ownedCharacterIds', 'directStakeBonusPercent',
      'payoutCurrencyId', 'defaultSlippage', 'currentNetworkId', 'partnerProjectMultipliers', 'partnerProjectRatios']) as Accessors<StoreMappedState>),
    ...(mapGetters([
      'ownCharacters', 'currentCharacter', 'maxRewardsClaimTaxAsFactorBN', 'rewardsClaimTaxAsFactorBN', 'getCharacterName', 'getPartnerProjects'
    ]) as Accessors<StoreMappedGetters>),

    formattedMultiplier(): number {
      return this.selectedPartneredProject && +toBN(this.partnerProjectMultipliers[+this.selectedPartneredProject.id]).div(toBN(10).pow(18)).toFixed(4) || 1;
    },

    nonFormattedRatio(): number {
      return this.selectedPartneredProject &&
        +toBN(1).dividedBy(toBN(this.partnerProjectRatios[+this.selectedPartneredProject.id]).dividedBy(toBN(2).exponentiatedBy(64))) || 1;
    },

    formattedSkillReward(): string {
      const skillRewards = fromWeiEther(this.skillRewards);
      return `${toBN(skillRewards).toFixed(4)}`;
    },

    formattedTaxAmount(): string {
      const skillRewards = fromWeiEther((parseFloat(this.skillRewards)* parseFloat(String(this.rewardsClaimTaxAsFactorBN))).toString());
      return `${toBN(skillRewards).toFixed(4)}`;
    },

    formattedBonusLost(): string {
      const skillLost = fromWeiEther((parseFloat(this.skillRewards)*this.directStakeBonusPercent/100).toString());
      return `${toBN(skillLost).toFixed(4)}`;
    },

    formattedRemainingClaimableSkill(): string {
      const skillClaimable = fromWeiEther(this.remainingTokenClaimAmountPreTax);
      return `${toBN(skillClaimable).toFixed(4)}`;
    },

    formattedRewardsClaimTax(): string {
      const frac =
        this.skillRewards === '0'
          ? this.maxRewardsClaimTaxAsFactorBN
          : this.rewardsClaimTaxAsFactorBN;

      return `${frac.multipliedBy(100).decimalPlaces(0, BigNumber.ROUND_HALF_UP)}%`;
    },

    currentMultiplier(): string {
      return (this.formattedMultiplier*100).toFixed(2) + '%';
    },

    skillRewardNumber(): number {
      return +toBN(fromWeiEther(this.skillRewards.substr(0, this.skillRewards.length - 3) + '000'));
    },

    xpRewardsForOwnedCharacters(): string[] {
      return this.ownedCharacterIds.map(charaId => this.xpRewards[charaId] || '0');
    },

    formattedXpRewardsBar(): string {
      return this.xpRewardsForOwnedCharacters.map((xp, i) => {
        const currentCharacter = this.currentCharacter || { id: null };
        if(!this.ownCharacters[i]) return `${xp}`;
        return  `${this.ownCharacters[i].id === currentCharacter.id ? '<b>' : ''}` +
                `${(this.ownCharacters[i].xp + this.xpRewards[this.ownCharacters[i].id]) as any > RequiredXp(this.ownCharacters[i].level) ? '<u>' : ''}` +
                `${(this.getCleanCharacterName(this.ownCharacters[i].id))} ${xp}` +
                `${(this.ownCharacters[i].xp + this.xpRewards[this.ownCharacters[i].id]) as any > RequiredXp(this.ownCharacters[i].level) ? '</u>' : ''}` +
                `${this.ownCharacters[i].id === currentCharacter.id ? '</b>' : ''}`;
      }).join(', ');
    },

    formattedXpRewards(): string[] {
      return this.xpRewardsForOwnedCharacters.map((xp, i) => {
        if(!this.ownCharacters[i]) return xp;

        return `${this.getCleanCharacterName(this.ownCharacters[i].id)} ${xp}`;
      });
    },

    canClaimTokens(): boolean {
      const areSkillRewardsZeroOrLess = toBN(this.skillRewards).lte(0);
      const isRemainingTokenClaimAmountPreTaxZeroOrLess = toBN(this.remainingTokenClaimAmountPreTax).lte(0);
      return !(areSkillRewardsZeroOrLess || isRemainingTokenClaimAmountPreTaxZeroOrLess);
    },

    canClaimXp(): boolean {
      const areAllXpsZeroOrLess = this.xpRewardsForOwnedCharacters.every(xp => toBN(xp).lte(0));
      return !areAllXpsZeroOrLess;
    },

    selectedPartneredProject(): SupportedProject | undefined {
      return this.getPartnerProjects.find(partnerProject => partnerProject.id.toString() === this.payoutCurrencyId.toString());
    },

    isNoProjectAvailable(): boolean {
      this.choosePayoutCurrencyIfNotChosenBefore();
      return this.payoutCurrencyId === '-1';
    },

    canClaimSelectedProject(): boolean {
      if(this.selectedPartneredProject) {
        return toBN(+this.selectedPartneredProject.tokensClaimed).div(toBN(10).pow(18)).toNumber()
          < toBN(+this.selectedPartneredProject.tokenSupply).toNumber();
      }
      return false;
    },

    isSkillAmountValid(): boolean {
      return this.skillAmount <= this.skillRewardNumber && this.skillAmount > 0;
    }
  },

  methods: {
    ...(mapActions(['addMoreSkill', 'claimTokenRewards', 'claimPartnerToken', 'claimXpRewards', 'fetchRemainingTokenClaimAmountPreTax',
      'fetchPartnerProjects', 'getPartnerProjectMultiplier', 'getSkillToPartnerRatio']) as StoreMappedActions),
    ...mapMutations(['updatePayoutCurrencyId']),

    async onClaimTokens() {
      if(this.payoutCurrencyId !== '-1') {
        const currentMultiplier = await this.getPartnerProjectMultiplier(+this.payoutCurrencyId);
        if(currentMultiplier === '0') {
          (this as any).$dialog.notify.error(i18n.t('ClaimRewardsBar.multiplierAtZero'));
          return;
        }
        await this.claimPartnerToken(
          {
            id: +this.payoutCurrencyId,
            skillAmount: toBN(this.skillAmount).multipliedBy(toBN(10).pow(18)).toString(),
            currentMultiplier: toBN(currentMultiplier).toString(),
            slippage: toBN(this.slippage).multipliedBy(toBN(10).pow(16)).toString()
          }
        );
      }
      else if(this.canClaimTokens) {
        await this.claimTokenRewards();
      }
    },

    async onClaimXp() {
      if(this.canClaimXp) {
        await this.claimXpRewards();
      }
    },

    async claimSkill(stage: ClaimStage) {
      if(stage === ClaimStage.WaxBridge) {
        (this.$refs['need-gas-modal'] as any).show();
      }
      if(stage === ClaimStage.Stake) {
        (this.$refs['stake-suggestion-modal'] as any).show();
      }
      if(stage === ClaimStage.Claim) {
        (this.$refs['stake-suggestion-modal'] as any).hide();
        (this.$refs['claim-confirmation-modal'] as any).show();
      }
      if(stage === ClaimStage.Summary) {
        await this.fetchPartnerProjects();
        this.skillAmount = this.skillRewardNumber;
        this.slippage = +toBN(this.defaultSlippage).dividedBy(toBN(10).pow(16));
        (this.$refs['claim-summary-modal'] as any).show();
      }
      await this.getRemainingTokenClaimAmountPreTax();
    },

    async getRemainingTokenClaimAmountPreTax() {
      this.remainingTokenClaimAmountPreTax = await this.fetchRemainingTokenClaimAmountPreTax();
    },

    choosePayoutCurrencyIfNotChosenBefore() {
      const supportedProjects = this.getPartnerProjects;
      if(this.payoutCurrencyId === '-1' && supportedProjects.length !== 0) {
        this.updatePayoutCurrencyId(supportedProjects[0].id);
      }
    },

    getCleanCharacterName(id: number): string {
      return getCleanName(this.getCharacterName(id));
    },

    getLogoFile(projectName: string): string {
      return `${projectName.toLowerCase()}.png`;
    },

    setMaxSkillAmount(): void {
      this.skillAmount = this.skillRewardNumber;
    }
  },

  async mounted() {
    this.updateInterval = setInterval(async () => await this.getRemainingTokenClaimAmountPreTax(), 3000);
  },

  beforeDestroy() {
    if (this.updateInterval) {
      clearInterval(this.updateInterval);
    }
  }
});
</script>

<style scoped>

.navbar {
  background: rgb(0, 0, 0);
}

.claim-xp-bar {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.nav-item.bar {
  margin-top: -24px;
}

.nav-item a {
  padding: 0;
}

.rewards-claimable-icon {
  margin-right: 5px;
  align-self: center;
}

.chars{
  margin-bottom: 0px;
  font-family: Roboto;
}

.diamond{
  color: #EDCD90;
  margin-right: 8px;
}

.note{
  color: rgba(255, 255, 255, 0.438);
  padding-top: 5px;
  font-size: 13px;
}

.note-warning{
  background-color: #EDCD90;
  padding: 5px;
  border-radius: 3px;
  color: rgb(0, 0, 0);
  text-align: center;
}

.reward-title{
  font-family: Trajan;
  color: #fff;
  font-size: 15px;
}

.nav-item.bar{
  margin-top: 0px;
  list-style-type: none;
  text-align: left;
  width: 100%;
}

.navbar.claim-skill{
  background-color: rgba(0, 0, 0, 0.281);
  border-radius: 5px;
  margin-bottom: 20px;
}

.exp-label{
  font-family: Trajan;
  color: #EDCD90;
  margin-bottom: 2px;
  font-size: 15px;
  margin-top: 15px;
}

.btn-claim{
  color: #EDCD90;
  border: 1px solid #EDCD90;
  padding: 5px 30px;
  margin-right: 20px;
  font-family: Roboto;
  border-radius: 5px;
  font-size: 13px;
}

.skill-label{
  font-family: Trajan;
  color: #ffffff;
  margin-bottom: 2px;
  font-size: 15px;
  margin-top: 15px;
}

.claim-input {
  max-height: 60%;
  max-width: 40%;
  margin-left: 5px;
}

.claim-input-text {
  margin-bottom: -1px;
}

.invalid-amount {
  border: 2px solid red;
}

.very-low-multiplier {
  color: rgb(223, 17, 17);
}
</style>
